{% extends 'base.html.twig' %}

{% block title %}Home{% endblock %}

{% block body %}
    <div class="app">
        <div class="songs-wrapper">
            <div class="row">
                {% set t = 1 %}
                {% for album in albums %}
                    <div class="col s12 m6 l4 x3">
                        <div class="{{ "active song album_"~ album.id }}" data-id = "{{ album.id }}">
                            <div class = "mini_disk" style="text-align: center;padding-top: 100px;padding-right: 180px">
                                {% if album.getStatus == 1 %}
                                    <span style="color: white;font-weight: bold;font-size: 16px">Vendu</span>
                                {% else %}
                                    <span style="color: white;font-weight: bold;font-size: 16px">Disponible</span>
                                {% endif %}
                            </div>

                            <div class = "menu_album" style="text-align: center;padding-top: 150px;padding-right: 20px">
                                <div class="open_modal_btn" style="color: white;font-weight: bold;font-size: 16px; margin-bottom: 4px" data-toggle="modal" data-target="#exampleModalLong" data-description = "{{ album.description }}">Lire la Description</div>
                                <div class="text_lecteur" style="color: white;font-weight: bold;font-size: 16px; margin-left: 1.6rem">
                                    <a  href="{{ path('app_show', {'id': album.id}) }}" >
                                        Accéder au lecteur  <i class='bx bxs-hand-right'></i>
                                    </a>
                                </div>
                            </div>
                            <div
                                    class="song-image"
                                    style="
                      background-image: url({{ asset('uploads/'~ album.image) }});
                    "
                            ></div>
                            <div class="song-info">
                                <div class="song-title">{{ album.title }}</div>
                                <div class="song-artist">
                                        <!-- Button trigger modal -->

                                            <button class="make_lector play-button">

                                                {%   if albumsId != null %}
                                                    <i class="material-icons">pause</i>
                                                {% else %}
                                                    <i class="material-icons">play_arrow</i>

                                                {% endif %}
                                            </button>

                            </div>

                            </div>
                            {% set audios = album.getInstrumentals %}

                            {% for audio in audios %}
                                    <audio data-song = "my song" id="{{ "audio-player_"~ t }}" data-id="{{ "audio-player_"~ t }}" class="audio-player" preload="none" src="{{ asset('audio/'~ audio.getFichierAudio) }}" data-piste="{{ t }}" ></audio>
                                {% set t = t + 1 %}
                            {% endfor %}
                        </div>

                    </div>

            {% endfor %}

            </div>
        </div>
        <div class="music-player">
            <div class="progress-wrapper">
                <div class="progress-bar"></div>
            </div>
            <div class="times-row">
                <div class="start-time">0:00</div>
                <div class="current-song">{{ titleAlbum==null?"":titleAlbum }}</div>
                <div class="end-time"></div>
            </div>
            <div class="player-actions">
                <button class="action-button">
                    <i class="material-icons">skip_previous</i>
                </button>
                <button class="play-button play_btn">
                    <i class="material-icons">play_arrow</i>
                </button>
                <button class="action-button">
                    <i class="material-icons">skip_next</i>
                </button>
            </div>
        </div>
    </div>
    <form id="choice_album_form" method = "GET" action = "{{ path('app_home') }}" style="display:none">
        <input type="album_id" name="album_id" id="album_id">
    </form>

    <!-- Modal -->
    <div class="modal fade" id="exampleModalLong" tabindex="-1" role="dialog" aria-labelledby="exampleModalLongTitle" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Description album</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="content_modal">
                    ...
                </div>
            </div>
        </div>
    </div>
<style>
    .song {
        position: relative;
    }
    .status_album {
        position: absolute;
        bottom:0;
        right: 9.6px;
    }



</style>
{% endblock %}
{% block javascripts %}
{{ parent() }}
<script
        src="https://code.jquery.com/jquery-3.6.4.js"
        integrity="sha256-a9jBBRygX1Bh5lt8GZjXDzyOB+bWve9EiO7tROUtj/E="
        crossorigin="anonymous"
></script>
    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.7.0/gsap.min.js"
            integrity="sha512-2fk3Q4NXPYAqIha0glLZ2nluueK43aNoxvijPf53+DgL7UW9mkN+uXc1aEmnZdkkZVvtJZltpRt+JqTWc3TS3Q=="
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

    <script>

    //média player
    $(document).ready(function() {

        var alumId = {{ albumsId==null?0:albumsId }}

        var audioPlayer
        var tabPiste = {};
        var numeroAudio = 0 //initialisation
        var progressBar = $('.progress-bar');

        if(alumId == 0) {
            $('.music-player').hide()
            $('.song').removeClass("active");
        }
        else {
            initialize()
        }

        $(".song").on("click", function (e) {
            console.log(e.target.id)
            if(e.target.classList.contains('open_modal_btn')) {
                $('#content_modal').empty()
                $('#content_modal').html($(e.target).data('description'))
                return;
            }

            var idAlbum = $(this).data('id')
            $('#album_id').val(idAlbum)
            $('#choice_album_form').submit()

        });
        let toggle = document.querySelector(".toggle");
        let body = document.querySelector("body");

        let tl = gsap.timeline();

        toggle.addEventListener("click", function () {
            if (body.classList.contains("open")) {
                //Fermer le menu.
                body.classList.remove("open");
                tl.to(".sep", {
                    duration: 0,
                    height: 0,
                });

                tl.to(".sep__icon", {
                    duration: 0,
                    opacity: 0,
                });
            } else {
                //Ouvrir le menu.
                body.classList.add("open");

                tl.to(".sep", {
                    duration: 0.75,
                    height: "100%",
                    delay: 0.5,
                });

                tl.to(".sep__icon", {
                    opacity: 1,
                    duration: 0.25,
                    delay: -0.5,
                });

                tl.from(
                    ".menu__left__inner__item",
                    {
                        y: 40,
                        opacity: 0,
                        stagger: 0.25,
                    },
                    "<-0.5"
                );

                tl.from(
                    ".menu__right__inner__item",
                    {
                        y: 40,
                        opacity: 0,
                        stagger: 0.25,
                    },
                    "<0.5"
                );
            }
        });

        function initialize() {
            $('.music-player').show('slow')
            $('.song').removeClass("active");
            // Obtenez la position de l'élément
            var position = $('.album_'+alumId).offset().top;

            // Effectuez le défilement jusqu'à la position de l'élément
            $('html, body').animate({
                scrollTop: position
            }, 1000);
            $('.album_'+alumId).addClass("active")
            tabPiste = {}
            if(typeof audioPlayer != 'undefined') {
                audioPlayer.pause()
                audioPlayer.currentTime = 0
                progressBar.width(0 + '%');
                $('.play_btn').html('<i class="material-icons">play_arrow</i>');
            }
            var audios = $('.album_'+alumId).children('audio');
            audios.each(function(element) {
                console.log('doule')
                tabPiste[$(this).data('piste')] = $(this).data('id')
            })
            $.each(tabPiste,function (key,val){
                if(val == undefined) {
                    tabPiste.splice(key,1)
                }
            })

            //s'il existe des pistes
            if(tabPiste.length != 0) {

                // Trouver la clé la plus petite
                var minKey = Math.min.apply(null, Object.keys(tabPiste));
                console.log(tabPiste)
                console.log(minKey)
                // Récupérer l'élément audio
                audioPlayer = $('#' + tabPiste[minKey])[0];
                numeroAudio = minKey
                // Récupérer les éléments DOM nécessaires

                var startTime = $('.start-time');
                var endTime = $('.end-time');
                var playButton = $('.play_btn');
                var prevButton = $('.player-actions .action-button:first');
                var nextButton = $('.player-actions .action-button:last');
                var currentSong = $('.current-song');
                var progressWrapper = $('.progress-wrapper');

                // Définir les valeurs initiales
                var isPlaying = false;
                var currentTime = 0;
                var duration = audioPlayer.duration;


                // Mise à jour de la barre de progression et du temps de lecture
                function updateProgress() {
                    currentTime = audioPlayer.currentTime;
                    duration = audioPlayer.duration;
                    if (!isNaN(duration)) {
                        var percent = currentTime / duration * 100;
                        progressBar.width(percent + '%');
                        startTime.text(formatTime(currentTime));
                        endTime.text(formatTime(duration));
                    }
                    if(currentTime == duration) {
                        numeroAudio++
                        pause()
                        if( tabPiste.hasOwnProperty(numeroAudio)) {
                            audioPlayer = $('#'+tabPiste[numeroAudio])[0];
                            currentSong.empty()
                            currentSong.append('<span>'+$('#'+tabPiste[numeroAudio]).data('sound')+'</span>')
                            play()
                        }
                        else {
                            numeroAudio--
                            pause()
                        }

                    }
                }

                // Formatage de la durée en minutes:secondes
                function formatTime(time) {
                    var minutes = Math.floor(time / 60);
                    var seconds = Math.floor(time % 60);
                    return minutes + ':' + (seconds < 10 ? '0' : '') + seconds;
                }

                // Lecture de la musique
                function play() {
                    audioPlayer.play();
                    isPlaying = true;
                    playButton.html('<i class="material-icons">pause</i>');
                }

                // Pause de la musique
                function pause() {
                    audioPlayer.pause();
                    isPlaying = false;
                    playButton.html('<i class="material-icons">play_arrow</i>');
                }

                // Bouton play/pause
                playButton.on('click', function () {
                    if (isPlaying) {
                        pause();
                    } else {
                        play();
                    }
                });

                // Bouton précédent
                prevButton.on('click', function () {
                    numeroAudio--
                    if(tabPiste.hasOwnProperty(numeroAudio)) {
                        pause()
                        audioPlayer = $('#'+tabPiste[numeroAudio])[0];
                        play()
                    }
                    else {
                        pause()
                        numeroAudio++
                        audioPlayer = $('#'+tabPiste[numeroAudio])[0];
                        play()
                    }
                });

                // Bouton suivant
                nextButton.on('click', function () {
                    numeroAudio++
                    if (tabPiste.hasOwnProperty(numeroAudio)) {
                        pause()
                        audioPlayer = $('#' + tabPiste[numeroAudio])[0];
                        play()
                    } else {
                        pause()
                        numeroAudio--
                        audioPlayer = $('#' + tabPiste[numeroAudio])[0];
                        play()
                    }
                });

                // Mettre à jour la barre de progression et le temps de lecture toutes les 500 millisecondes
                setInterval(updateProgress, 500);
                // Ramener la chanson au début lorsque l'utilisateur clique sur la barre de progression
                progressBar.on('click', function (e) {

                    var pos = (e.pageX - $(this).offset().left) / $(this).width();
                    audioPlayer.currentTime = pos * duration;
                });
                // Variables pour le déplacement de la barre de progression
                var isDragging = false;
                var startX = 0;
                var dragOffset = 0;

                // Fonction de démarrage du déplacement
                function startDrag(e) {
                    isDragging = true;
                    startX = e.pageX;
                    dragOffset = startX - progressBar.offset().left;
                }

                // Fonction de déplacement de la barre de progression
                function drag(e) {
                    if (isDragging) {
                        var pos = (e.pageX - progressBar.offset().left - dragOffset) / progressBar.width();
                        pos = Math.max(0, Math.min(1, pos)); // S'assurer que la position est entre 0 et 1
                        audioPlayer.currentTime = pos * duration;
                        updateProgress();
                    }
                }

                // Fonction d'arrêt du déplacement
                function stopDrag() {
                    isDragging = false;
                }

                // Événements pour le déplacement de la barre de progression
                progressBar.on('mousedown', startDrag);
                $(document).on('mousemove', drag);
                $(document).on('mouseup', stopDrag);

                // Déplacer la barre de progression au clic sur progress-wrapper si une chanson est sélectionnée
                progressWrapper.on('click', function (e) {
                    if (isSongSelected() && !isNaN(duration)) {
                        var pos = (e.pageX - $(this).offset().left) / $(this).width();
                        audioPlayer.currentTime = pos * duration;
                        updateProgress();
                    }
                });

                // Vérifier si une chanson est sélectionnée
                function isSongSelected() {
                    return audioPlayer.src !== "";
                }
            }
        }
    })

    //---fin média player
</script>
{% endblock %}